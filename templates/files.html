{% extends "base.html" %}

{% block content %}
<section>
    <h1>文件列表</h1>
    <form action="{{ url_for('files') }}" class="search-form" method="get">
        <input class="form-control" name="search" placeholder="搜索文件..." type="text" value="{{ search_query }}" oninput="showSuggestions(this.value)">
        <button class="button" type="submit">搜索</button>
        <div id="search-suggestions" style="display: none;"></div>
    </form>
    <div class="batch-actions">
        <button class="button" onclick="downloadSelected()">下载选中项</button>
        <label class="select-all">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" aria-label="全选">
            全选
        </label>
    </div>
    <table class="table table-striped">
        <thead>
        <tr>
            <th>选择</th>
            <th>描述</th>
            <th>类型</th>
            <th>上传者</th>
            <th>大小</th>
            <th>上传时间</th>
            <th>操作</th>
            <th>分享链接</th>
        </tr>
        </thead>
        <tbody>
        {% for directory in directories %}
        <tr style="border-bottom: 1px;border-bottom: 2px dotted;border-bottom: medium dashed blue;">
            <td><input type="checkbox" class="select-item" data-type="directory" data-id="{{ directory.id }}"></td>
            <td>{{ directory.description }}</td>
            <td>目录</td>
            <td><a href="{{ url_for('user_profile', username=directory.uploader.username) }}"
                   style="text-decoration: none;">{{
                directory.uploader.username }}<img
                        alt="头像"
                        src="{{ url_for('static', filename='images/avatar/' + directory.uploader.username + '.png') }}" style="width: 40px; height: 40px; border-radius: 50%;"></a></td>
            <td>-</td>
            <td>{{ directory.upload_time }}</td>
            <td>
                <a class="button" href="{{ url_for('directory_detail', directory_id=directory.id) }}">进入目录</a>
            </td>
            <td>-</td>
        </tr>
        {% endfor %}
        {% for file in files %}
        <tr style="border-bottom: 1px;border-bottom: 2px dotted;border-bottom: medium dashed blue;">
            <td><input type="checkbox" class="select-item" data-type="file" data-id="{{ file.download_link }}"></td>
            <td>{{ file.description }}</td>
            <td>文件</td>
            <td><a href="{{ url_for('user_profile', username=file.uploader.username) }}" style="text-decoration: none;">{{
                file.uploader.username }}<img
                        alt="头像"
                        src="{{ url_for('static', filename='images/avatar/' + file.uploader.username + '.png') }}" style="width: 40px; height: 40px; border-radius: 50%;"></a></td>
            <td>{{ file.file_size|filesizeformat }}</td>
            <td>{{ file.upload_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td>
                <a class="button" href="{{ url_for('download', download_link=file.download_link) }}"
                   style="margin-bottom: 5px;margin-top: 5px;">下载</a>
                <a class="button" href="{{ url_for('file_detail', file_id=file.id) }}">预览</a>
            </td>
            <td>
                {% if file.share_link %}
                <a class="button" href="{{ url_for('share_file', share_link=file.share_link) }}"
                   target="_blank">查看分享链接</a>
                <form action="{{ url_for('file_manager') }}" class="d-inline-block" method="post">
                    <input name="file_id" type="hidden" value="{{ file.id }}">
                    <input name="action" type="hidden" value="delete_share_link">
                    <button class="button" type="submit">删除分享链接</button>
                </form>
                {% else %}
                <form action="{{ url_for('file_manager') }}" class="d-inline-block" method="post">
                    <input name="file_id" type="hidden" value="{{ file.id }}">
                    <input name="action" type="hidden" value="create_share_link">
                    <label class="div_input" style="margin-bottom: 5px;">
                        <input name="password" type="password">
                        <div class="underline"></div>
                        <label>设置密码</label>
                    </label>
                    <button class="button" type="submit">创建分享链接</button>
                </form>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    <div class="pagination">
        {% if pagination.has_prev %}
            <a class="page-link" href="{{ url_for('files', page=pagination.prev_num, search=search_query) }}">上一页</a>
        {% endif %}

        {% for page_num in pagination.iter_pages() %}
            <a class="page-link {% if page_num == pagination.page %}active{% endif %}"
               href="{{ url_for('files', page=page_num, search=search_query) }}">{{ page_num }}</a>
        {% endfor %}

        {% if pagination.has_next %}
            <a class="page-link" href="{{ url_for('files', page=pagination.next_num, search=search_query) }}">下一页</a>
        {% endif %}
    </div>
</section>

<script>
    function showSuggestions(query) {
        if (query.length > 2) {
            fetch(`/search_suggestions?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    const suggestions = document.getElementById('search-suggestions');
                    suggestions.innerHTML = data.map(item => `<div>${item}</div>`).join('');
                    suggestions.style.display = 'block';
                });
        } else {
            document.getElementById('search-suggestions').style.display = 'none';
        }
    }

    // 下载
    function downloadSelected() {
        const items = document.querySelectorAll('.select-item:checked');
        let downloadPromises = [];

        items.forEach(item => {
            if (item.dataset.type === 'file') {
                // 如果是文件，直接下载
                window.open(`/download/${item.dataset.id}`, '_blank');
            } else if (item.dataset.type === 'directory') {
                // 如果是目录，获取目录内的所有文件并下载
                const directoryId = item.dataset.id;
                fetch(`/directory_files/${directoryId}`)
                    .then(response => response.json())
                    .then(files => {
                        files.forEach(file => {
                            window.open(`/download/${file.download_link}`, '_blank');
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching directory files:', error);
                    });
            }
        });

        // 提示用户查看新标签页
        if (items.length > 0) {
            alert('已在后台打开下载链接，请查看浏览器下载列表');
        }
    }

    // 全选/反选功能
    function toggleSelectAll(source) {
        const checkboxes = document.querySelectorAll('.select-item');
        checkboxes.forEach(checkbox => {
            checkbox.checked = source.checked;
        });

        // 更新全选按钮状态
        updateSelectAllState();
    }

    // 更新全选按钮状态
    function updateSelectAllState() {
        const checkboxes = document.querySelectorAll('.select-item');
        const selectAllCheckbox = document.getElementById('selectAll');

        if (checkboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.disabled = true;
            return;
        }

        selectAllCheckbox.disabled = false;

        // 检查是否所有复选框都被选中
        const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
        selectAllCheckbox.checked = allChecked;

        // 处理部分选中状态
        const someChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
        selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }

    // 为每个复选框添加事件监听器
    function setupCheckboxListeners() {
        const checkboxes = document.querySelectorAll('.select-item');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectAllState);
        });
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        setupCheckboxListeners();
        updateSelectAllState();
    });
</script>

{% endblock %}
